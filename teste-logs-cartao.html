<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PRODUÃ‡ÃƒO - Pagamento com CartÃ£o (R$ 1,00)</title>
    <link rel="icon" type="image/jpeg" href="logo.jpg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #58a6ff;
            margin-bottom: 1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 2rem;
        }

        .warning-banner {
            background: #d29922;
            color: #0d1117;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 2rem;
            font-weight: bold;
            text-align: center;
        }

        .status {
            background: #161b22;
            border: 1px solid #30363d;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 6px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6e7681;
        }

        .status-indicator.success {
            background: #3fb950;
            box-shadow: 0 0 10px #3fb950;
        }

        .status-indicator.error {
            background: #f85149;
            box-shadow: 0 0 10px #f85149;
        }

        .status-indicator.processing {
            background: #d29922;
            box-shadow: 0 0 10px #d29922;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .form-section {
            background: #161b22;
            border: 1px solid #30363d;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 6px;
        }

        .form-section h2 {
            color: #58a6ff;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #8b949e;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-family: 'Courier New', monospace;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #2ea043;
        }

        .btn:disabled {
            background: #21262d;
            color: #8b949e;
            cursor: not-allowed;
        }

        .logs-container {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            max-height: 600px;
            overflow-y: auto;
        }

        .logs-container h2 {
            color: #58a6ff;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .log-entry {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 3px solid #30363d;
            background: #161b22;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .log-entry.info {
            border-left-color: #58a6ff;
        }

        .log-entry.success {
            border-left-color: #3fb950;
        }

        .log-entry.error {
            border-left-color: #f85149;
            background: #1c1416;
        }

        .log-entry.warning {
            border-left-color: #d29922;
        }

        .log-timestamp {
            color: #8b949e;
            font-size: 0.75rem;
            margin-bottom: 0.3rem;
        }

        .log-message {
            color: #c9d1d9;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .error-detail {
            background: #0d1117;
            padding: 1rem;
            margin-top: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .clear-btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .clear-btn:hover {
            background: #30363d;
        }

        .highlight-value {
            color: #d29922;
            font-weight: bold;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Teste PRODUÃ‡ÃƒO - Pagamento com CartÃ£o</h1>

        <div class="warning-banner">
            âš ï¸ AMBIENTE DE PRODUÃ‡ÃƒO - Teste com R$ 1,00 - CARTÃƒO REAL SERÃ COBRADO
        </div>

        <div class="status">
            <div class="status-item">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Aguardando teste...</span>
            </div>
        </div>

        <div class="form-section">
            <h2>ğŸ“ Dados da InscriÃ§Ã£o</h2>

            <div class="form-group">
                <label>Nome Completo *</label>
                <input type="text" id="nome" value="ALEX GUIMARAES DOS SANTOS" required />
            </div>

            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="email" value="alexguimaraes@outlook.com" required />
            </div>

            <div class="form-group">
                <label>CPF * (use seu CPF real)</label>
                <input type="text" id="cpf" value="07531603667" required />
            </div>

            <div class="form-group">
                <label>Telefone (com DDD) *</label>
                <input type="text" id="telefone" value="11951329984" required />
            </div>

            <div class="form-group">
                <label>Data de Nascimento *</label>
                <input type="date" id="data_nascimento" value="1990-01-01" required />
            </div>

            <div class="form-group">
                <label>Valor do Teste (R$) *</label>
                <input type="number" id="valor_teste" value="1.00" step="0.01" min="1" required />
                <small style="color: #8b949e; display: block; margin-top: 0.5rem;">
                    âš ï¸ Este valor serÃ¡ cobrado no seu cartÃ£o de crÃ©dito real!
                </small>
            </div>
        </div>

        <div class="form-section">
            <h2>ğŸ’³ Dados do CartÃ£o (REAL - SERÃ COBRADO)</h2>

            <div class="form-group">
                <label>NÃºmero do CartÃ£o *</label>
                <input type="text" id="cartao_numero" value="" placeholder="0000 0000 0000 0000" maxlength="19" required />
            </div>

            <div class="form-group">
                <label>Nome do Titular *</label>
                <input type="text" id="cartao_titular" value="" placeholder="Como estÃ¡ no cartÃ£o" required />
            </div>

            <div class="form-group">
                <label>Validade (MM/AA) *</label>
                <input type="text" id="cartao_validade" value="" placeholder="12/30" maxlength="5" required />
            </div>

            <div class="form-group">
                <label>CVV *</label>
                <input type="text" id="cartao_cvv" value="" placeholder="123" maxlength="4" required />
            </div>

            <div class="form-group">
                <label>Parcelas</label>
                <select id="parcelas">
                    <option value="1" selected>Ã€ vista (1x) - Valor: <span id="valor1x">R$ 1,00</span></option>
                    <option value="2">2x sem juros</option>
                    <option value="3">3x sem juros</option>
                </select>
            </div>

            <button class="btn" id="btnTestar" onclick="testarFluxoCompleto()">
                ğŸ§ª Testar Fluxo Completo (InscriÃ§Ã£o + Pagamento)
            </button>
        </div>

        <div class="logs-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>ğŸ“‹ Logs do Teste Completo</h2>
                <button class="clear-btn" onclick="limparLogs()">Limpar Logs</button>
            </div>
            <div id="logsDisplay"></div>
        </div>
    </div>

    <script src="https://assets.pagseguro.com.br/checkout-sdk-js/rc/dist/browser/pagseguro.min.js"></script>
    <script>
        let logs = [];
        let idInscricaoGerado = null;

        function addLog(type, message, details = null) {
            const timestamp = new Date().toLocaleString('pt-BR');
            logs.push({ type, message, details, timestamp });
            renderLogs();
        }

        function renderLogs() {
            const display = document.getElementById('logsDisplay');
            if (logs.length === 0) {
                display.innerHTML = '<div class="log-entry info">Nenhum log capturado ainda...</div>';
                return;
            }

            display.innerHTML = logs.map((log, index) => `
                <div class="log-entry ${log.type}">
                    <div class="log-timestamp">[${log.timestamp}]</div>
                    <div class="log-message">${escapeHtml(log.message)}</div>
                    ${log.details ? `<div class="error-detail">${escapeHtml(JSON.stringify(log.details, null, 2))}</div>` : ''}
                </div>
            `).join('');

            // Auto scroll to bottom
            display.scrollTop = display.scrollHeight;
        }

        function escapeHtml(unsafe) {
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function limparLogs() {
            logs = [];
            idInscricaoGerado = null;
            renderLogs();
            updateStatus('default', 'Logs limpos. Aguardando novo teste...');
        }

        function updateStatus(type, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            indicator.className = 'status-indicator';
            if (type === 'success') indicator.classList.add('success');
            else if (type === 'error') indicator.classList.add('error');
            else if (type === 'processing') indicator.classList.add('processing');

            text.textContent = message;
        }

        async function testarFluxoCompleto() {
            const btn = document.getElementById('btnTestar');
            btn.disabled = true;
            btn.textContent = 'â³ Processando...';

            logs = []; // Limpar logs anteriores
            idInscricaoGerado = null;
            updateStatus('processing', 'Iniciando teste...');

            try {
                addLog('info', 'ğŸš€ INICIANDO TESTE COMPLETO EM PRODUÃ‡ÃƒO');
                addLog('warning', 'âš ï¸ ATENÃ‡ÃƒO: Usando ambiente de PRODUÃ‡ÃƒO - cartÃ£o real serÃ¡ cobrado!');

                // === ETAPA 1: CRIAR INSCRIÃ‡ÃƒO ===
                addLog('info', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                addLog('info', 'ğŸ“ ETAPA 1: Criando inscriÃ§Ã£o no sistema...');
                addLog('info', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                const nome = document.getElementById('nome').value;
                const email = document.getElementById('email').value;
                const cpf = document.getElementById('cpf').value;
                const telefone = document.getElementById('telefone').value;
                const dataNascimento = document.getElementById('data_nascimento').value;
                const valorTeste = parseFloat(document.getElementById('valor_teste').value);

                // Criar objeto de inscriÃ§Ã£o completo
                const dadosInscricao = {
                    nome_completo: nome,
                    email: email,
                    cpf: cpf,
                    telefone: telefone,
                    data_nascimento: dataNascimento,
                    tipo_participante: 'TESTE',
                    valor_inscricao: valorTeste,
                    metodo_pagamento: 'CARTAO',
                    numero_parcelas_cartao: parseInt(document.getElementById('parcelas').value)
                };

                addLog('info', 'ğŸ“¤ Enviando dados para /api/inscricao:', dadosInscricao);

                const inscricaoResponse = await fetch('/api/inscricao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dadosInscricao)
                });

                const inscricaoData = await inscricaoResponse.json();
                addLog('info', `ğŸ“¥ Resposta /api/inscricao (status ${inscricaoResponse.status}):`, inscricaoData);

                if (!inscricaoResponse.ok) {
                    throw new Error('Erro ao criar inscriÃ§Ã£o: ' + (inscricaoData.message || inscricaoData.error));
                }

                // Capturar ID da inscriÃ§Ã£o
                idInscricaoGerado = inscricaoData.inscricao?.id_inscricao;

                if (!idInscricaoGerado) {
                    throw new Error('ID da inscriÃ§Ã£o nÃ£o foi retornado pela API!');
                }

                addLog('success', `âœ… InscriÃ§Ã£o criada com sucesso!`);
                addLog('success', `ğŸ†” ID DA INSCRIÃ‡ÃƒO GERADO: ${idInscricaoGerado}`);

                // === ETAPA 2: PROCESSAR PAGAMENTO ===
                addLog('info', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                addLog('info', 'ğŸ’³ ETAPA 2: Processando pagamento com cartÃ£o...');
                addLog('info', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                // Coletar dados do cartÃ£o
                const cartaoNumero = document.getElementById('cartao_numero').value.replace(/\s/g, '');
                const cartaoTitular = document.getElementById('cartao_titular').value;
                const cartaoValidade = document.getElementById('cartao_validade').value;
                const cartaoCvv = document.getElementById('cartao_cvv').value;
                const parcelas = parseInt(document.getElementById('parcelas').value);

                // Validar dados do cartÃ£o
                if (!cartaoNumero || !cartaoTitular || !cartaoValidade || !cartaoCvv) {
                    throw new Error('Preencha todos os dados do cartÃ£o!');
                }

                addLog('info', 'ğŸ“ Dados do cartÃ£o:', {
                    numero_final: cartaoNumero.slice(-4),
                    titular: cartaoTitular,
                    validade: cartaoValidade,
                    parcelas: parcelas
                });

                // Buscar chave pÃºblica
                addLog('info', 'ğŸ”‘ Buscando chave pÃºblica do PagBank...');
                const keyResponse = await fetch('/api/pagbank-public-key');
                const keyData = await keyResponse.json();

                if (!keyResponse.ok) {
                    throw new Error('Erro ao obter chave pÃºblica: ' + keyData.message);
                }

                addLog('success', `âœ… Chave pÃºblica obtida (ambiente: ${keyData.environment})`);
                addLog('info', `ğŸ“ Ambiente PagBank: ${keyData.environment.toUpperCase()}`);

                // Criptografar cartÃ£o
                addLog('info', 'ğŸ” Criptografando dados do cartÃ£o...');
                const [mes, ano] = cartaoValidade.split('/');
                const anoCompleto = '20' + ano;

                const card = window.PagSeguro.encryptCard({
                    publicKey: keyData.publicKey,
                    holder: cartaoTitular,
                    number: cartaoNumero,
                    expMonth: mes,
                    expYear: anoCompleto,
                    securityCode: cartaoCvv
                });

                const cartaoEncrypted = card.encryptedCard;
                addLog('success', 'âœ… CartÃ£o criptografado com sucesso');
                addLog('info', `ğŸ” Encrypted Card length: ${cartaoEncrypted.length} chars`);

                // Enviar pagamento COM ID_INSCRICAO
                addLog('info', 'ğŸ’³ Enviando requisiÃ§Ã£o de pagamento para /api/pagamento-cartao...');
                addLog('info', `ğŸ†” Usando ID da inscriÃ§Ã£o: ${idInscricaoGerado}`);

                const payloadPagamento = {
                    id_inscricao: idInscricaoGerado, // USAR ID_INSCRICAO (nÃ£o inscricao_id)
                    nome_completo: nome,
                    email: email,
                    cpf: cpf,
                    telefone: telefone,
                    valor_total: valorTeste,
                    cartao_encrypted: cartaoEncrypted,
                    cartao_titular: cartaoTitular,
                    cartao_numero_final: cartaoNumero.slice(-4),
                    cartao_bandeira: 'VISA',
                    numero_parcelas_cartao: parcelas
                };

                addLog('info', 'ğŸ“¤ Payload completo do pagamento:', payloadPagamento);

                const pagamentoResponse = await fetch('/api/pagamento-cartao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payloadPagamento)
                });

                const pagamentoData = await pagamentoResponse.json();

                addLog('info', `ğŸ“¥ Resposta /api/pagamento-cartao (status ${pagamentoResponse.status}):`, pagamentoData);

                if (!pagamentoResponse.ok) {
                    addLog('error', 'âŒ ERRO NO PAGAMENTO: ' + (pagamentoData.message || pagamentoData.error), pagamentoData);
                    updateStatus('error', 'Erro no pagamento: ' + (pagamentoData.message || pagamentoData.error));
                    throw new Error('Pagamento falhou: ' + (pagamentoData.message || pagamentoData.error));
                }

                // === RESULTADO FINAL ===
                addLog('info', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                addLog('info', 'ğŸ“Š RESULTADO FINAL');
                addLog('info', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                if (pagamentoData.approved) {
                    addLog('success', 'âœ… PAGAMENTO APROVADO COM SUCESSO!');
                    addLog('success', `ğŸ†” ID InscriÃ§Ã£o: ${idInscricaoGerado}`);
                    addLog('success', `ğŸ“¦ Order ID PagBank: ${pagamentoData.order_id}`);
                    addLog('success', `ğŸ’³ Charge ID: ${pagamentoData.charge_id}`);
                    addLog('success', `ğŸ’° Valor cobrado: R$ ${valorTeste.toFixed(2)}`);
                    addLog('success', `ğŸ“‹ Parcelas: ${parcelas}x`);
                    updateStatus('success', `Pagamento aprovado! ID: ${idInscricaoGerado}`);
                } else {
                    addLog('warning', 'â³ Pagamento em processamento', pagamentoData);
                    addLog('info', `Status: ${pagamentoData.status}`);
                    updateStatus('processing', 'Pagamento em processamento');
                }

                addLog('info', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                addLog('success', 'âœ… TESTE COMPLETO FINALIZADO!');
                addLog('info', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            } catch (error) {
                addLog('error', 'âŒ ERRO CRÃTICO NO TESTE: ' + error.message, {
                    name: error.name,
                    stack: error.stack
                });
                updateStatus('error', 'Erro: ' + error.message);
                console.error('Erro completo:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ§ª Testar Fluxo Completo (InscriÃ§Ã£o + Pagamento)';
            }
        }

        // Atualizar valor nas parcelas quando mudar o valor do teste
        document.getElementById('valor_teste').addEventListener('input', function(e) {
            const valor = parseFloat(e.target.value) || 1.00;
            const select = document.getElementById('parcelas');
            select.innerHTML = `
                <option value="1" selected>Ã€ vista (1x) - R$ ${valor.toFixed(2)}</option>
                <option value="2">2x de R$ ${(valor/2).toFixed(2)}</option>
                <option value="3">3x de R$ ${(valor/3).toFixed(2)}</option>
            `;
        });

        // Formatar nÃºmero do cartÃ£o
        document.getElementById('cartao_numero').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Formatar validade
        document.getElementById('cartao_validade').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });

        // Renderizar logs iniciais
        renderLogs();
    </script>
</body>
</html>

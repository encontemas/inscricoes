<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Logs - Teste de Pagamento com Cart√£o</title>
    <link rel="icon" type="image/jpeg" href="logo.jpg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #58a6ff;
            margin-bottom: 1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 2rem;
        }

        .status {
            background: #161b22;
            border: 1px solid #30363d;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 6px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6e7681;
        }

        .status-indicator.success {
            background: #3fb950;
            box-shadow: 0 0 10px #3fb950;
        }

        .status-indicator.error {
            background: #f85149;
            box-shadow: 0 0 10px #f85149;
        }

        .status-indicator.processing {
            background: #d29922;
            box-shadow: 0 0 10px #d29922;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .form-section {
            background: #161b22;
            border: 1px solid #30363d;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 6px;
        }

        .form-section h2 {
            color: #58a6ff;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #8b949e;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-family: 'Courier New', monospace;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #2ea043;
        }

        .btn:disabled {
            background: #21262d;
            color: #8b949e;
            cursor: not-allowed;
        }

        .logs-container {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            max-height: 600px;
            overflow-y: auto;
        }

        .logs-container h2 {
            color: #58a6ff;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .log-entry {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 3px solid #30363d;
            background: #161b22;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .log-entry.info {
            border-left-color: #58a6ff;
        }

        .log-entry.success {
            border-left-color: #3fb950;
        }

        .log-entry.error {
            border-left-color: #f85149;
            background: #1c1416;
        }

        .log-entry.warning {
            border-left-color: #d29922;
        }

        .log-timestamp {
            color: #8b949e;
            font-size: 0.75rem;
            margin-bottom: 0.3rem;
        }

        .log-message {
            color: #c9d1d9;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .error-detail {
            background: #0d1117;
            padding: 1rem;
            margin-top: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .clear-btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .clear-btn:hover {
            background: #30363d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Captura de Logs - Teste de Pagamento com Cart√£o</h1>

        <div class="status">
            <div class="status-item">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Aguardando teste...</span>
            </div>
        </div>

        <div class="form-section">
            <h2>Dados do Teste</h2>

            <div class="form-group">
                <label>Nome Completo</label>
                <input type="text" id="nome" value="TESTE LOGS PAGBANK" />
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" value="teste-logs@example.com" />
            </div>

            <div class="form-group">
                <label>CPF</label>
                <input type="text" id="cpf" value="12345678900" />
            </div>

            <div class="form-group">
                <label>Telefone (com DDD)</label>
                <input type="text" id="telefone" value="11999999999" />
            </div>

            <div class="form-group">
                <label>N√∫mero do Cart√£o</label>
                <input type="text" id="cartao_numero" value="4539620659922097" placeholder="Cart√£o de teste VISA" />
            </div>

            <div class="form-group">
                <label>Nome do Titular</label>
                <input type="text" id="cartao_titular" value="TESTE LOGS" />
            </div>

            <div class="form-group">
                <label>Validade (MM/AA)</label>
                <input type="text" id="cartao_validade" value="12/30" maxlength="5" />
            </div>

            <div class="form-group">
                <label>CVV</label>
                <input type="text" id="cartao_cvv" value="123" maxlength="4" />
            </div>

            <div class="form-group">
                <label>Parcelas</label>
                <select id="parcelas">
                    <option value="1">√Ä vista (1x)</option>
                    <option value="2">2x sem juros</option>
                    <option value="3">3x sem juros</option>
                    <option value="11" selected>11x sem juros</option>
                </select>
            </div>

            <button class="btn" id="btnTestar" onclick="testarPagamento()">üß™ Testar Pagamento e Capturar Logs</button>
        </div>

        <div class="logs-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>üìã Logs Capturados</h2>
                <button class="clear-btn" onclick="limparLogs()">Limpar Logs</button>
            </div>
            <div id="logsDisplay"></div>
        </div>
    </div>

    <script src="https://assets.pagseguro.com.br/checkout-sdk-js/rc/dist/browser/pagseguro.min.js"></script>
    <script>
        let logs = [];

        function addLog(type, message, details = null) {
            const timestamp = new Date().toLocaleString('pt-BR');
            logs.push({ type, message, details, timestamp });
            renderLogs();
        }

        function renderLogs() {
            const display = document.getElementById('logsDisplay');
            if (logs.length === 0) {
                display.innerHTML = '<div class="log-entry info">Nenhum log capturado ainda...</div>';
                return;
            }

            display.innerHTML = logs.map((log, index) => `
                <div class="log-entry ${log.type}">
                    <div class="log-timestamp">[${log.timestamp}]</div>
                    <div class="log-message">${escapeHtml(log.message)}</div>
                    ${log.details ? `<div class="error-detail">${escapeHtml(JSON.stringify(log.details, null, 2))}</div>` : ''}
                </div>
            `).reverse().join('');

            // Auto scroll to bottom
            display.scrollTop = display.scrollHeight;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function limparLogs() {
            logs = [];
            renderLogs();
            updateStatus('default', 'Logs limpos. Aguardando novo teste...');
        }

        function updateStatus(type, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            indicator.className = 'status-indicator';
            if (type === 'success') indicator.classList.add('success');
            else if (type === 'error') indicator.classList.add('error');
            else if (type === 'processing') indicator.classList.add('processing');

            text.textContent = message;
        }

        async function testarPagamento() {
            const btn = document.getElementById('btnTestar');
            btn.disabled = true;
            btn.textContent = '‚è≥ Processando...';

            logs = []; // Limpar logs anteriores
            updateStatus('processing', 'Processando pagamento...');

            try {
                addLog('info', 'üöÄ Iniciando teste de pagamento com cart√£o');

                // Coletar dados
                const nome = document.getElementById('nome').value;
                const email = document.getElementById('email').value;
                const cpf = document.getElementById('cpf').value;
                const telefone = document.getElementById('telefone').value;
                const cartaoNumero = document.getElementById('cartao_numero').value.replace(/\s/g, '');
                const cartaoTitular = document.getElementById('cartao_titular').value;
                const cartaoValidade = document.getElementById('cartao_validade').value;
                const cartaoCvv = document.getElementById('cartao_cvv').value;
                const parcelas = parseInt(document.getElementById('parcelas').value);

                addLog('info', 'üìù Dados coletados:', {
                    nome, email, cpf, telefone,
                    cartao: cartaoNumero.slice(-4),
                    titular: cartaoTitular,
                    validade: cartaoValidade,
                    parcelas
                });

                // Buscar chave p√∫blica
                addLog('info', 'üîë Buscando chave p√∫blica do PagBank...');
                const keyResponse = await fetch('/api/pagbank-public-key');
                const keyData = await keyResponse.json();

                if (!keyResponse.ok) {
                    throw new Error('Erro ao obter chave p√∫blica: ' + keyData.message);
                }

                addLog('success', `‚úÖ Chave p√∫blica obtida (ambiente: ${keyData.environment})`);

                // Criptografar cart√£o
                addLog('info', 'üîê Criptografando dados do cart√£o...');
                const [mes, ano] = cartaoValidade.split('/');
                const anoCompleto = '20' + ano;

                const card = window.PagSeguro.encryptCard({
                    publicKey: keyData.publicKey,
                    holder: cartaoTitular,
                    number: cartaoNumero,
                    expMonth: mes,
                    expYear: anoCompleto,
                    securityCode: cartaoCvv
                });

                const cartaoEncrypted = card.encryptedCard;
                addLog('success', '‚úÖ Cart√£o criptografado com sucesso');
                addLog('info', 'Encrypted Card (primeiros 50 chars):', cartaoEncrypted.substring(0, 50) + '...');

                // Enviar pagamento
                addLog('info', 'üí≥ Enviando requisi√ß√£o de pagamento para /api/pagamento-cartao...');

                const payloadCompleto = {
                    inscricao_id: email,
                    nome_completo: nome,
                    email: email,
                    cpf: cpf,
                    telefone: telefone,
                    valor_total: 450.00,
                    cartao_encrypted: cartaoEncrypted,
                    cartao_numero_final: cartaoNumero.slice(-4),
                    cartao_bandeira: 'VISA',
                    numero_parcelas_cartao: parcelas
                };

                addLog('info', 'Payload enviado:', payloadCompleto);

                const pagamentoResponse = await fetch('/api/pagamento-cartao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payloadCompleto)
                });

                const pagamentoData = await pagamentoResponse.json();

                addLog('info', `üì• Resposta recebida (status ${pagamentoResponse.status}):`, pagamentoData);

                if (!pagamentoResponse.ok) {
                    addLog('error', '‚ùå ERRO: ' + (pagamentoData.message || pagamentoData.error), pagamentoData);
                    updateStatus('error', 'Erro: ' + (pagamentoData.message || pagamentoData.error));
                } else {
                    if (pagamentoData.approved) {
                        addLog('success', '‚úÖ PAGAMENTO APROVADO!', pagamentoData);
                        updateStatus('success', 'Pagamento aprovado com sucesso!');
                    } else {
                        addLog('warning', '‚è≥ Pagamento em processamento', pagamentoData);
                        updateStatus('processing', 'Pagamento em processamento');
                    }
                }

            } catch (error) {
                addLog('error', '‚ùå ERRO CR√çTICO: ' + error.message, {
                    name: error.name,
                    stack: error.stack
                });
                updateStatus('error', 'Erro cr√≠tico: ' + error.message);
                console.error('Erro completo:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üß™ Testar Pagamento e Capturar Logs';
            }
        }

        // Renderizar logs iniciais
        renderLogs();
    </script>
</body>
</html>
